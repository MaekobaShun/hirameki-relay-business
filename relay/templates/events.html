{% extends "base.html" %}

{% block title %}イベント - ひらめきリレー{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='events.css') }}">
{% endblock %}


{% block header_intro %}
<p class="header-eyebrow">EVENTS</p>
<h1 class="header-title">イベント</h1>
{% endblock %}

{% block content %}
<div class="events-wrapper">
    <!-- Action Buttons (Create / Join) -->
    <div class="event-actions-grid">
        <!-- Create Event -->
        <div class="action-card create-event-card" onclick="document.getElementById('create-event-modal').showModal()">
            <div class="card-icon-wrapper">
                <img src="{{ url_for('static', filename='images/calendar-add-svgrepo-com.svg') }}" class="card-icon-svg" alt="作成">
            </div>
            <div class="card-text">
                <h3>イベントを作成</h3>
                <p>新しいテーマでイベントを主催しよう</p>
            </div>
        </div>
        
        <!-- Join Event (Quick) -->
        <div class="action-card join-event-card" onclick="document.getElementById('join-event-modal').showModal()">
            <div class="card-icon-wrapper" style="background: #e0e7ff;">
                <img src="{{ url_for('static', filename='images/entry-svgrepo-com.svg') }}" class="card-icon-svg" alt="参加">
            </div>
            <div class="card-text">
                <h3>イベントに参加</h3>
                <p>IDとパスワードで参加</p>
            </div>
        </div>
    </div>

    <!-- My Events Section -->
    <section class="ranking-section" style="margin-top: 2rem;">
        <div class="section-header">
            <h3 class="section-title">
                <img src="{{ url_for('static', filename='/images/event-badged-1-svgrepo-com.svg') }}" class="section-title-icon icon-participating" alt="参加中">
                参加中のイベント
            </h3>
        </div>
        {% if my_events %}
        <div class="my-events-grid">
            {% for event in my_events %}
                <!-- Event Card (MyPage Style) -->
                <div class="event-card {{ event.status }}">
                    <div class="event-card-body">
                        <div class="event-card-header-badges">
                            {% if event.status == 'active' %}
                                <span class="status-badge status-active">開催中</span>
                            {% elif event.status == 'upcoming' %}
                                <span class="status-badge status-upcoming">開催予定</span>
                            {% else %}
                                <span class="status-badge status-ended">終了</span>
                            {% endif %}
                        </div>
                        
                        <h3 class="event-card-title">{{ event.name }}</h3>
                        
                        <div class="event-info">
                            <div class="info-item">
                                <img src="{{ url_for('static', filename='images/event-svgrepo-com.svg') }}" alt="期間" class="info-icon {% if event.status == 'ended' %}icon-ended{% endif %}">
                                {{ event.start_date.strftime('%m/%d %H:%M') }} 〜
                            </div>
                            <div class="info-item">
                                <img src="{{ url_for('static', filename='images/user-svgrepo-com.svg') }}" alt="主催" class="info-icon {% if event.status == 'ended' %}icon-ended{% endif %}">
                                主催: {{ event.creator_nickname }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-card-footer">
                        <span style="font-size: 0.8rem; color: #94a3b8;">{{ event.created_at.strftime('%Y/%m/%d') }}</span>
                        <form method="POST" action="{{ url_for('event_join') }}">
                            <input type="hidden" name="event_id" value="{{ event.event_id }}">
                            <button type="submit" class="btn-sm {% if event.status == 'ended' %}btn-secondary-sm{% else %}btn-primary-sm{% endif %}">
                                {% if event.status == 'ended' %}結果を見る{% else %}会場へ移動{% endif %}
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: #9ca3af; padding: 3rem; background: #f9fafb; border-radius: 1rem;">現在参加しているイベントはありません</p>
        {% endif %}
    </section>

    <!-- All Public Events List -->
    <section class="ranking-section" style="margin-top: 2rem;">
        <div class="section-header">
            <h3 class="section-title">
                <img src="{{ url_for('static', filename='images/event-svgrepo-com.svg') }}" class="section-title-icon icon-all-events" alt="一覧">
                開催中のイベント一覧
            </h3>
        </div>
        
        {% if other_events %}
        <div class="all-events-grid">
            {% for event in other_events %}
            <div class="event-card {{ event.status }}">
                <div class="event-card-body">
                    <div class="event-card-header-badges">
                        {% if event.status == 'active' %}
                            <span class="status-badge status-active">開催中</span>
                        {% elif event.status == 'upcoming' %}
                            <span class="status-badge status-upcoming">開催予定</span>
                        {% endif %}
                    </div>
                    
                    <h3 class="event-card-title">{{ event.name }}</h3>
                    
                    <div class="event-info">
                        <div class="info-item">
                            <img src="{{ url_for('static', filename='images/event-svgrepo-com.svg') }}" alt="期間" class="info-icon">
                            {{ event.start_date.strftime('%Y/%m/%d') }} 〜
                        </div>
                        <div class="info-item">
                            <img src="{{ url_for('static', filename='images/user-svgrepo-com.svg') }}" alt="主催" class="info-icon">
                            主催: {{ event.creator_nickname }}
                        </div>
                    </div>
                </div>
                
                <div class="event-card-footer">
                    <span style="font-size: 0.8rem; color: #94a3b8;">{{ event.created_at.strftime('%Y/%m/%d') }}</span>
                    <button class="btn-sm btn-primary-sm" onclick="openJoinModal('{{ event.event_id }}')">参加</button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: #9ca3af; padding: 3rem; background: #f9fafb; border-radius: 1rem;">現在公開されているイベントはありません</p>
        {% endif %}
    </section>

    <!-- Ended Events Section -->
    {% if ended_events %}
    <section class="ranking-section" style="margin-top: 2rem;">
        <div class="section-header">
            <h3 class="section-title">
                <img src="{{ url_for('static', filename='images/calendar-svgrepo-com.svg') }}" class="section-title-icon icon-ended" alt="終了">
                終了したイベント
            </h3>
        </div>
        <div class="all-events-grid">
            {% for event in ended_events %}
            <div class="event-card {{ event.status }}">
                <div class="event-card-body">
                    <div class="event-card-header-badges">
                        <span class="status-badge status-ended">終了</span>
                    </div>
                    
                    <h3 class="event-card-title">{{ event.name }}</h3>
                    
                    <div class="event-info">
                        <div class="info-item">
                            <img src="{{ url_for('static', filename='images/event-svgrepo-com.svg') }}" alt="期間" class="info-icon">
                            {{ event.start_date.strftime('%Y/%m/%d') }} 〜 {{ event.end_date.strftime('%Y/%m/%d') }}
                        </div>
                        <div class="info-item">
                            <img src="{{ url_for('static', filename='images/user-svgrepo-com.svg') }}" alt="主催" class="info-icon">
                            主催: {{ event.creator_nickname }}
                        </div>
                    </div>
                </div>
                
                <div class="event-card-footer">
                    <span style="font-size: 0.8rem; color: #94a3b8;">{{ event.created_at.strftime('%Y/%m/%d') }}</span>
                    {% if event.is_participant %}
                    <a href="{{ url_for('event_ended', event_id=event.event_id) }}" class="btn-sm btn-secondary-sm" style="text-decoration: none; display: inline-block;">結果を見る</a>
                    {% else %}
                    <span style="font-size: 0.85rem; color: #94a3b8;">終了済み</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<!-- Modals -->
<dialog id="create-event-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>イベントを作成</h3>
            <button type="button" onclick="document.getElementById('create-event-modal').close()" class="modal-close-btn">×</button>
        </div>
        <form method="POST" action="{{ url_for('event_create') }}" class="modal-form">
             <div class="form-group">
                <label for="event_name">イベント名</label>
                <input type="text" id="event_name" name="name" required placeholder="例：夏のアイデアコンテスト">
            </div>
            <div class="form-group password-toggle">
                <label for="event_password_create">パスワード</label>
                <div class="password-input-wrapper">
                    <input type="password" id="event_password_create" name="password" required placeholder="参加者に共有するパスワード">
                    <button type="button" data-target="event_password_create">表示</button>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="start_date">開始日時</label>
                    <input type="datetime-local" id="start_date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="end_date">終了日時</label>
                    <input type="datetime-local" id="end_date" name="end_date" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="document.getElementById('create-event-modal').close()" class="btn-cancel">キャンセル</button>
                <button type="submit" class="btn-submit">作成する</button>
            </div>
        </form>
    </div>
</dialog>

<dialog id="join-event-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>イベントに参加</h3>
            <button type="button" onclick="document.getElementById('join-event-modal').close()" class="modal-close-btn">×</button>
        </div>
        <form method="POST" action="{{ url_for('event_join') }}" class="modal-form">
             <div class="form-group">
                <label for="event_select_modal">イベントを選択（任意）</label>
                <select id="event_select_modal" name="event_select" onchange="updateEventId(this)">
                    <option value="">イベントを選択...</option>
                    {% if other_events %}
                        {% for event in other_events %}
                            {% if event.status == 'active' or event.status == 'upcoming' %}
                            <option value="{{ event.event_id }}">{{ event.name }} ({{ event.start_date.strftime('%m/%d') }}~)</option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="form-group password-toggle">
                <label for="event_password_modal">パスワード</label>
                <div class="password-input-wrapper">
                    <input type="password" id="event_password_modal" name="password" required placeholder="イベントパスワードを入力">
                    <button type="button" data-target="event_password_modal">表示</button>
                </div>
                <input type="hidden" id="modal_event_id" name="event_id" value="">
            </div>
            <div class="modal-footer">
                <button type="button" onclick="document.getElementById('join-event-modal').close()" class="btn-cancel">キャンセル</button>
                <button type="submit" class="btn-submit">参加する</button>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
    function openJoinModal(eventId) {
        const modal = document.getElementById('join-event-modal');
        const select = document.getElementById('event_select_modal');
        
        document.getElementById('modal_event_id').value = eventId;
        select.value = eventId;
        
        modal.showModal();
    }
    
    function updateEventId(select) {
         document.getElementById('modal_event_id').value = select.value;
    }
    
    // Close modal when clicking outside
    document.querySelectorAll('dialog').forEach(dialog => {
        dialog.addEventListener('click', (event) => {
            if (event.target === dialog) {
                dialog.close();
            }
        });
    });
    
    // Password toggle functionality
    document.querySelectorAll('.password-toggle button').forEach(function(button) {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            if (!input) {
                return;
            }
            if (input.type === 'password') {
                input.type = 'text';
                this.textContent = '非表示';
            } else {
                input.type = 'password';
                this.textContent = '表示';
            }
        });
    });
</script>
{% endblock %}
