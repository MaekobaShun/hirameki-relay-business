{% extends "base.html" %}

{% block title %}ã‚¤ãƒ™ãƒ³ãƒˆ - ã²ã‚‰ã‚ããƒªãƒ¬ãƒ¼{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='events.css') }}">
{% endblock %}


{% block header_intro %}
<p class="header-eyebrow">EVENTS</p>
<h1 class="header-title">ã‚¤ãƒ™ãƒ³ãƒˆ</h1>
{% endblock %}

{% block content %}
<div class="events-wrapper">
    <!-- Action Buttons (Create / Join) -->
    <div class="event-actions-grid">
        <!-- Create Event -->
        <div class="action-card create-event-card" onclick="document.getElementById('create-event-modal').showModal()">
            <div class="card-icon-wrapper">
                <img src="{{ url_for('static', filename='images/calendar-add-svgrepo-com.svg') }}" class="card-icon-svg" alt="ä½œæˆ">
            </div>
            <div class="card-text">
                <h3>ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ</h3>
                <p>æ–°ã—ã„ãƒ†ãƒ¼ãƒã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸»å‚¬ã—ã‚ˆã†</p>
            </div>
        </div>
        
        <!-- Join Event (Quick) -->
        <div class="action-card join-event-card" onclick="document.getElementById('join-event-modal').showModal()">
            <div class="card-icon-wrapper" style="background: #e0e7ff;">
                <img src="{{ url_for('static', filename='images/entry-svgrepo-com.svg') }}" class="card-icon-svg" alt="å‚åŠ ">
            </div>
            <div class="card-text">
                <h3>ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ </h3>
                <p>IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§å‚åŠ </p>
            </div>
        </div>
    </div>

    <!-- My Events Section -->
    {% if my_events %}
    <section class="ranking-section" style="margin-top: 2rem;">
        <div class="section-header">
            <h3 class="section-title">
                <img src="{{ url_for('static', filename='images/ranking-1-svgrepo-com.svg') }}" class="section-title-icon icon-participating" alt="å‚åŠ ä¸­">
                å‚åŠ ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            </h3>
        </div>
        <div class="my-events-grid">
            {% for event in my_events %}
                <!-- Event Card (MyPage Style) -->
                <div class="event-card {{ event.status }}">
                    <div class="event-card-body">
                        <div class="event-card-header-badges">
                            {% if event.status == 'active' %}
                                <span class="status-badge status-active">é–‹å‚¬ä¸­</span>
                            {% elif event.status == 'upcoming' %}
                                <span class="status-badge status-upcoming">é–‹å‚¬äºˆå®š</span>
                            {% else %}
                                <span class="status-badge status-ended">çµ‚äº†</span>
                            {% endif %}
                            
                            {% if event.is_public %}
                                <span class="visibility-badge">å…¬é–‹</span>
                            {% else %}
                                <span class="visibility-badge private">éå…¬é–‹</span>
                            {% endif %}
                        </div>
                        
                        <h3 class="event-card-title">{{ event.name }}</h3>
                        
                        <div class="event-info">
                            <div class="info-item">
                                <span class="icon">ğŸ“…</span>
                                {{ event.start_date.strftime('%m/%d %H:%M') }} ã€œ
                            </div>
                            <div class="info-item">
                                <span class="icon">ğŸ‘¤</span>
                                ä¸»å‚¬: {{ event.creator_nickname }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="event-card-footer">
                        <span style="font-size: 0.8rem; color: #94a3b8;">{{ event.created_at.strftime('%Y/%m/%d') }}</span>
                        <form method="POST" action="{{ url_for('event_join') }}">
                            <input type="hidden" name="event_id" value="{{ event.event_id }}">
                            <button type="submit" class="btn-sm {% if event.status == 'ended' %}btn-secondary-sm{% else %}btn-primary-sm{% endif %}">
                                {% if event.status == 'ended' %}çµæœã‚’è¦‹ã‚‹{% else %}ä¼šå ´ã¸ç§»å‹•{% endif %}
                            </button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- All Public Events List -->
    <section class="ranking-section" style="margin-top: 2rem;">
        <div class="section-header">
            <h3 class="section-title">
                <img src="{{ url_for('static', filename='images/event-svgrepo-com.svg') }}" class="section-title-icon icon-all-events" alt="ä¸€è¦§">
                é–‹å‚¬ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
            </h3>
        </div>
        
        {% if other_events %}
        <div class="all-events-grid">
            {% for event in other_events %}
            <div class="event-card {{ event.status }}">
                <div class="event-card-body">
                    <div class="event-card-header-badges">
                        {% if event.status == 'active' %}
                            <span class="status-badge status-active">é–‹å‚¬ä¸­</span>
                        {% elif event.status == 'upcoming' %}
                            <span class="status-badge status-upcoming">é–‹å‚¬äºˆå®š</span>
                        {% endif %}
                        
                        <span class="visibility-badge">å…¬é–‹</span>
                    </div>
                    
                    <h3 class="event-card-title">{{ event.name }}</h3>
                    
                    <div class="event-info">
                        <div class="info-item">
                            <span class="icon">ğŸ“…</span>
                            {{ event.start_date.strftime('%Y/%m/%d') }} ã€œ
                        </div>
                        <div class="info-item">
                            <span class="icon">ğŸ‘¤</span>
                            ä¸»å‚¬: {{ event.creator_nickname }}
                        </div>
                    </div>
                </div>
                
                <div class="event-card-footer">
                    <span style="font-size: 0.8rem; color: #94a3b8;">{{ event.created_at.strftime('%Y/%m/%d') }}</span>
                    <button class="btn-sm btn-primary-sm" onclick="openJoinModal('{{ event.event_id }}')">å‚åŠ </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="text-align: center; color: #9ca3af; padding: 3rem; background: #f9fafb; border-radius: 1rem;">ç¾åœ¨å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
        {% endif %}
    </section>
</div>

<!-- Modals -->
<dialog id="create-event-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ</h3>
            <button type="button" onclick="document.getElementById('create-event-modal').close()" class="modal-close-btn">Ã—</button>
        </div>
        <form method="POST" action="{{ url_for('event_create') }}" class="modal-form">
             <div class="form-group">
                <label for="event_name">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                <input type="text" id="event_name" name="name" required placeholder="ä¾‹ï¼šå¤ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ">
            </div>
            <div class="form-group">
                <label for="event_password_create">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="event_password_create" name="password" required placeholder="å‚åŠ è€…ã«å…±æœ‰ã™ã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="start_date">é–‹å§‹æ—¥æ™‚</label>
                    <input type="datetime-local" id="start_date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="end_date">çµ‚äº†æ—¥æ™‚</label>
                    <input type="datetime-local" id="end_date" name="end_date" required>
                </div>
            </div>
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="is_public" name="is_public" value="1">
                    <span>ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…¬é–‹ã™ã‚‹</span>
                </label>
                <p class="form-hint">å…¬é–‹ã—ãªã„å ´åˆã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã®ã¿å‚åŠ ã§ãã¾ã™</p>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="document.getElementById('create-event-modal').close()" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="btn-submit">ä½œæˆã™ã‚‹</button>
            </div>
        </form>
    </div>
</dialog>

<dialog id="join-event-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ã‚¤ãƒ™ãƒ³ãƒˆã«å‚åŠ </h3>
            <button type="button" onclick="document.getElementById('join-event-modal').close()" class="modal-close-btn">Ã—</button>
        </div>
        <form method="POST" action="{{ url_for('event_join') }}" class="modal-form">
             <div class="form-group">
                <label for="event_select_modal">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠï¼ˆä»»æ„ï¼‰</label>
                <select id="event_select_modal" name="event_select" onchange="updateEventId(this)">
                    <option value="">ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ...</option>
                    {% if other_events %}
                        {% for event in other_events %}
                            {% if event.status == 'active' or event.status == 'upcoming' %}
                            <option value="{{ event.event_id }}">{{ event.name }} ({{ event.start_date.strftime('%m/%d') }}~)</option>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="form-group">
                <label for="event_password_modal">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="event_password_modal" name="password" required placeholder="ã‚¤ãƒ™ãƒ³ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                <input type="hidden" id="modal_event_id" name="event_id" value="">
            </div>
            <div class="modal-footer">
                <button type="button" onclick="document.getElementById('join-event-modal').close()" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="btn-submit">å‚åŠ ã™ã‚‹</button>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}

{% block extra_scripts %}
<script>
    function openJoinModal(eventId) {
        const modal = document.getElementById('join-event-modal');
        const select = document.getElementById('event_select_modal');
        
        document.getElementById('modal_event_id').value = eventId;
        select.value = eventId;
        
        modal.showModal();
    }
    
    function updateEventId(select) {
         document.getElementById('modal_event_id').value = select.value;
    }
    
    // Close modal when clicking outside
    document.querySelectorAll('dialog').forEach(dialog => {
        dialog.addEventListener('click', (event) => {
            if (event.target === dialog) {
                dialog.close();
            }
        });
    });
</script>
{% endblock %}
