<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ひらめきリレー{% endblock %}</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/logo_3.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/logo_3.png') }}">
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/logo_3.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/logo_3.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='common.css') }}">
    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <a href="{{ url_for('index') }}" class="sidebar-header">
            <img src="{{ url_for('static', filename='images/logo_2.png') }}" alt="ひらめきリレー" class="logo-icon">
            <h2 class="logo-text">ひらめきリレー</h2>
        </a>
        <nav class="sidebar-nav">
            <a href="{{ url_for('index') }}" class="nav-item {% if request.endpoint == 'index' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/home-svgrepo-com.svg') }}" class="nav-icon-svg" alt="ホーム">
                <span>ホーム</span>
            </a>
            <a href="{{ url_for('form') }}" class="nav-item {% if request.endpoint == 'form' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/edit-1479-svgrepo-com.svg') }}" class="nav-icon-svg" alt="投稿">
                <span>投稿する</span>
            </a>
            <a href="{{ url_for('gacha') }}" class="nav-item {% if request.endpoint == 'gacha' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/die-5-svgrepo-com.svg') }}" class="nav-icon-svg" alt="ガチャ">
                <span>ガチャ</span>
            </a>
            <a href="{{ url_for('ranking') }}" class="nav-item {% if request.endpoint == 'ranking' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/trophy-svgrepo-com.svg') }}" class="nav-icon-svg" alt="ランキング">
                <span>ランキング</span>
            </a>
            <a href="{{ url_for('events') }}" class="nav-item {% if request.endpoint == 'events' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/event-svgrepo-com.svg') }}" class="nav-icon-svg" alt="イベント">
                <span>イベント</span>
            </a>
             <a href="{{ url_for('mypage') }}" class="nav-item {% if request.endpoint == 'mypage' %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/user-svgrepo-com.svg') }}" class="nav-icon-svg" alt="マイページ">
                <span>マイページ</span>
            </a>
            <!--
            <a href="#" class="nav-item disabled">
                <span class="nav-icon">⚙️</span>
                <span>設定</span>
            </a>
            -->
        </nav>
    </aside>

    <!-- Main Wrapper -->
    <div class="main-wrapper">
        <!-- Header -->
        <header class="dashboard-header header">
            <button class="sidebar-toggle" id="sidebar-toggle" aria-label="メニュー">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="header-intro">
                {% block header_intro %}
                {% endblock %}
            </div>
            <div class="header-actions">
                <!-- チケット表示 -->
                <div class="header-ticket-display">
                    <img src="{{ url_for('static', filename='images/ticket-5-svgrepo-com.svg') }}" alt="チケット" class="header-ticket-icon">
                    <span class="header-ticket-count">{{ ticket_count }}</span>
                </div>
                <!-- 通知機能 -->
                <button class="notification-btn" id="notification-bell">
                    <img src="{{ url_for('static', filename='images/bell-svgrepo-com.svg') }}" class="notification-icon-svg" alt="通知">
                    {% if unread_notification_count and unread_notification_count > 0 %}
                    <span class="notification-badge" id="notification-badge">{{ unread_notification_count }}</span>
                    {% endif %}
                </button>
                <a href="{{ url_for('mypage') }}" class="user-profile">
                    <!-- アイコンがあれば表示、なければイニシャル -->
                    {% if session.get('icon_path') %}
                        {% if session['icon_path'].startswith('http') %}
                            <img src="{{ session['icon_path'] }}" alt="{{ session.get('nickname', 'User') }}" class="user-avatar">
                        {% else %}
                            <img src="{{ url_for('uploaded_file', filename=session['icon_path'].split('/')[-1]) }}" alt="{{ session.get('nickname', 'User') }}" class="user-avatar">
                        {% endif %}
                    {% else %}
                        <div class="user-avatar-placeholder">
                            {{ session.get('nickname', 'U')[0] }}
                        </div>
                    {% endif %}
                    <span class="user-name">{{ session.get('nickname', 'Guest') }}</span>
                </a>
            </div>
        </header>

        <!-- Content -->
        <main class="dashboard-content">
            {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="flash-messages" style="margin-bottom: 2rem; padding: 1rem; background: #fee2e2; color: #b91c1c; border-radius: 0.5rem;">
                {% for message in messages %}
                <p>{{ message }}</p>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </main>
    </div>

    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    {% include 'notification_panel.html' %}
    <script src="{{ url_for('static', filename='header.js') }}" defer></script>
    <script>
        // 相対時間表示の共通関数（日本時間対応）
        function formatRelativeTime(dateString) {
            // データベースから取得した時刻文字列を日本時間として解釈
            // フォーマット: 'YYYY-MM-DD HH:MM:SS'（JSTとして保存されている）
            let date;
            if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)) {
                // タイムゾーン情報がない場合、日本時間（JST, UTC+9）として解釈
                // 時刻文字列をパースして、UTC時刻として解釈した後、JSTオフセット（+9時間）を適用
                const [datePart, timePart] = dateString.split(' ');
                const [year, month, day] = datePart.split('-').map(Number);
                const [hour, minute, second] = timePart.split(':').map(Number);
                // 日本時間をUTC時刻として扱い、9時間戻してUTCに変換
                // データベースの時刻はJSTなので、UTCにするには9時間引く
                date = new Date(Date.UTC(year, month - 1, day, hour - 9, minute, second || 0));
            } else {
                date = new Date(dateString);
            }
            
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            // 1分以内
            if (diffSec < 60) {
                return diffSec + '秒前';
            }
            // 1時間以内
            else if (diffMin < 60) {
                return diffMin + '分前';
            }
            // 1日以内
            else if (diffHour < 24) {
                return diffHour + '時間前';
            }
            // 7日以内
            else if (diffDay < 7) {
                return diffDay + '日前';
            }
            // 7日以降は年月日を表示（日本時間で表示）
            else {
                // 日本時間で表示するために、UTC時刻に9時間を加算
                const jstDate = new Date(date.getTime() + (9 * 60 * 60 * 1000));
                const year = jstDate.getUTCFullYear();
                const month = String(jstDate.getUTCMonth() + 1).padStart(2, '0');
                const day = String(jstDate.getUTCDate()).padStart(2, '0');
                return `${year}/${month}/${day}`;
            }
        }
        
        // ページ読み込み時に相対時間を更新
        document.addEventListener('DOMContentLoaded', function() {
            const relativeTimes = document.querySelectorAll('.relative-time');
            relativeTimes.forEach(elem => {
                const timestamp = elem.getAttribute('data-timestamp');
                if (timestamp) {
                    elem.textContent = formatRelativeTime(timestamp);
                }
            });
        });
    </script>
    {% block extra_scripts %}{% endblock %}
</body>

</html>