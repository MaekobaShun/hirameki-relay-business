{% extends "base.html" %}

{% block title %}ãƒ©ãƒ³ã‚­ãƒ³ã‚° - ã²ã‚‰ã‚ããƒªãƒ¬ãƒ¼{% endblock %}

{% block header_intro %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='ranking.css') }}">
{% endblock %}

{% block content %}
{% set total_ranked = rankings|length if rankings else 0 %}
{% set top_ranking = rankings[0] if rankings else None %}
<div class="ranking-main">
    <section class="ranking-hero">
        <div class="hero-copy">
            <h2>æŠ•ç¨¿æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            <div class="hero-metrics">
                <div class="metric-card">
                    <span class="metric-label">ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°</span>
                    <span class="metric-value">{{ total_ranked }}</span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">ãƒˆãƒƒãƒ—æŠ•ç¨¿</span>
                    <span class="metric-value">
                        {% if top_ranking %}
                            {{ top_ranking.post_count }}
                        {% else %}
                            â€”
                        {% endif %}
                    </span>
                    <span class="metric-footnote">
                        {% if top_ranking %}
                            {{ top_ranking.nickname }}
                        {% else %}
                            é›†è¨ˆä¸­
                        {% endif %}
                    </span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">ã‚ãªãŸã®é †ä½</span>
                    <span class="metric-value">
                        {% if current_user_rank %}
                            {{ current_user_rank }}ä½
                        {% else %}
                            â€”
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </section>

    <section class="ranking-container">
        <div class="ranking-tabs">
            <button class="tab-button active" data-tab="posts">
                <span class="tab-label">æŠ•ç¨¿æ•°</span>
            </button>
            <button class="tab-button disabled" data-tab="inheritance" disabled>
                <span class="tab-label">ç¶™æ‰¿æ•°</span>
                <span class="tab-badge">æº–å‚™ä¸­</span>
            </button>
        </div>

        <!-- Period Tabs -->
        <div class="period-tabs">
            <button class="period-tab {% if current_period == 'all' %}active{% endif %}" data-period="all">ç·åˆ</button>
            <button class="period-tab {% if current_period == 'yearly' %}active{% endif %}" data-period="yearly">å¹´é–“</button>
            <button class="period-tab {% if current_period == 'monthly' %}active{% endif %}" data-period="monthly">æœˆé–“</button>
            <button class="period-tab {% if current_period == 'weekly' %}active{% endif %}" data-period="weekly">é€±é–“</button>
        </div>

            <!-- Ranking Content for each period -->
        <div class="ranking-content">
            {% for period_key, period_name in [('all', 'ç·åˆ'), ('yearly', 'å¹´é–“'), ('monthly', 'æœˆé–“'), ('weekly', 'é€±é–“')] %}
            <div class="period-ranking-content" data-period="{{ period_key }}" {% if current_period != period_key %}style="display: none;"{% else %}style="display: block;"{% endif %}>
                {% set period_rankings = rankings_by_period[period_key] %}
                {% if period_rankings %}
                <div class="ranking-list">
                    {% for ranking in period_rankings %}
                    <div class="ranking-item {% if ranking.user_id == current_user_id %}current-user{% endif %}">
                        <div class="rank-number">
                            {% if ranking.rank == 1 %}
                                <span class="rank-icon">ğŸ¥‡</span>
                            {% elif ranking.rank == 2 %}
                                <span class="rank-icon">ğŸ¥ˆ</span>
                            {% elif ranking.rank == 3 %}
                                <span class="rank-icon">ğŸ¥‰</span>
                            {% else %}
                                <span class="rank-text">{{ ranking.rank }}</span>
                            {% endif %}
                        </div>
                        <div class="user-info">
                            <div class="user-avatar">
                                {% if ranking.icon_path %}
                                    {% if ranking.icon_path.startswith('uploads/') %}
                                        <img src="{{ url_for('uploaded_file', filename=ranking.icon_path[8:]) }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% elif ranking.icon_path.startswith('http') %}
                                        <img src="{{ ranking.icon_path }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% else %}
                                        <img src="{{ url_for('static', filename=ranking.icon_path) }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% endif %}
                                {% else %}
                                    <span class="avatar-text">{{ ranking.nickname[0] if ranking.nickname else 'U' }}</span>
                                {% endif %}
                            </div>
                            <div class="user-details">
                                <div class="user-name">{{ ranking.nickname }}</div>
                                <div class="user-id">@{{ ranking.user_id }}</div>
                            </div>
                        </div>
                        <div class="rank-stats">
                            <div class="stat-value">{{ ranking.post_count }}</div>
                            <div class="stat-label">æŠ•ç¨¿</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-message">
                    <p>ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodTabs = document.querySelectorAll('.period-tab');
    const periodContents = document.querySelectorAll('.period-ranking-content');
    
    periodTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const period = this.getAttribute('data-period');
            
            // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
            periodTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            periodContents.forEach(content => {
                if (content.getAttribute('data-period') === period) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
            
            // URLã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
            const url = new URL(window.location);
            url.searchParams.set('period', period);
            window.history.pushState({}, '', url);
            
            // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é †ä½ã‚’å†è¨ˆç®—
            const activeContent = document.querySelector(`.period-ranking-content[data-period="${period}"]`);
            if (activeContent) {
                const currentUserItems = activeContent.querySelectorAll('.ranking-item.current-user');
                // é †ä½ã®å†è¡¨ç¤ºã¯å¿…è¦ã«å¿œã˜ã¦å®Ÿè£…
            }
        });
    });
});
</script>
{% endblock %}
