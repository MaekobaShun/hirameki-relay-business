{% extends "base.html" %}

{% block title %}ランキング - ひらめきリレー{% endblock %}

{% block header_intro %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='ranking.css') }}">
{% endblock %}

{% block content %}
<div class="ranking-main">
    <section class="ranking-hero">
        <div class="hero-copy">
            <h2>あなたのランキング</h2>
            <div class="hero-metrics" id="user-rankings">
                <div class="metric-card">
                    <span class="metric-label">投稿数順位</span>
                    <span class="metric-value" id="post-rank-value">
                        {% if current_user_post_rank %}
                            {{ current_user_post_rank }}位
                        {% else %}
                            —
                        {% endif %}
                    </span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">継承数順位</span>
                    <span class="metric-value" id="inheritance-rank-value">
                        {% if current_user_inheritance_rank %}
                            {{ current_user_inheritance_rank }}位
                        {% else %}
                            —
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </section>

    <section class="ranking-container">
        <div class="ranking-tabs">
            <button class="tab-button active" data-tab="posts">
                <span class="tab-label">投稿数</span>
            </button>
            <button class="tab-button disabled" data-tab="inheritance" disabled>
                <span class="tab-label">継承数</span>
                <span class="tab-badge">準備中</span>
            </button>
        </div>

        <!-- Period Tabs -->
        <div class="period-tabs">
            <button class="period-tab {% if current_period == 'all' %}active{% endif %}" data-period="all">総合</button>
            <button class="period-tab {% if current_period == 'yearly' %}active{% endif %}" data-period="yearly">年間</button>
            <button class="period-tab {% if current_period == 'monthly' %}active{% endif %}" data-period="monthly">月間</button>
            <button class="period-tab {% if current_period == 'weekly' %}active{% endif %}" data-period="weekly">週間</button>
        </div>

            <!-- Ranking Content for each period -->
        <div class="ranking-content">
            {% for period_key, period_name in [('all', '総合'), ('yearly', '年間'), ('monthly', '月間'), ('weekly', '週間')] %}
            <div class="period-ranking-content" data-period="{{ period_key }}" {% if current_period != period_key %}style="display: none;"{% else %}style="display: block;"{% endif %}>
                {% set period_rankings = rankings_by_period[period_key] %}
                {% if period_rankings %}
                <div class="ranking-list">
                    {% for ranking in period_rankings %}
                    <div class="ranking-item {% if ranking.user_id == current_user_id %}current-user{% endif %}">
                        <div class="rank-number {% if ranking.rank == 1 %}rank-gold{% elif ranking.rank == 2 %}rank-silver{% elif ranking.rank == 3 %}rank-bronze{% endif %}">
                            <span class="rank-text">{{ ranking.rank }}</span>
                        </div>
                        <div class="user-info">
                            <div class="user-avatar">
                                {% if ranking.icon_path %}
                                    {% if ranking.icon_path.startswith('uploads/') %}
                                        <img src="{{ url_for('uploaded_file', filename=ranking.icon_path[8:]) }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% elif ranking.icon_path.startswith('http') %}
                                        <img src="{{ ranking.icon_path }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% else %}
                                        <img src="{{ url_for('static', filename=ranking.icon_path) }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% endif %}
                                {% else %}
                                    <span class="avatar-text">{{ ranking.nickname[0] if ranking.nickname else 'U' }}</span>
                                {% endif %}
                            </div>
                            <div class="user-details">
                                <div class="user-name">{{ ranking.nickname }}</div>
                                <div class="user-id">@{{ ranking.user_id }}</div>
                            </div>
                        </div>
                        <div class="rank-stats">
                            <div class="stat-value">{{ ranking.post_count }}</div>
                            <div class="stat-label">投稿</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-message">
                    <p>まだランキングデータがありません。</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodTabs = document.querySelectorAll('.period-tab');
    const periodContents = document.querySelectorAll('.period-ranking-content');
    
    // 期間別の順位データ
    const userRanksByPeriod = {
        {% set periods = [('all', '総合'), ('yearly', '年間'), ('monthly', '月間'), ('weekly', '週間')] %}
        {% for period_key, period_name in periods %}
        '{{ period_key }}': {
            post_rank: {% if user_ranks_by_period[period_key]['post_rank'] %}{{ user_ranks_by_period[period_key]['post_rank'] }}{% else %}null{% endif %},
            inheritance_rank: {% if user_ranks_by_period[period_key]['inheritance_rank'] %}{{ user_ranks_by_period[period_key]['inheritance_rank'] }}{% else %}null{% endif %}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };
    
    function updateUserRankings(period) {
        const ranks = userRanksByPeriod[period];
        const postRankElement = document.getElementById('post-rank-value');
        const inheritanceRankElement = document.getElementById('inheritance-rank-value');
        
        if (postRankElement) {
            postRankElement.textContent = ranks.post_rank ? ranks.post_rank + '位' : '—';
        }
        if (inheritanceRankElement) {
            inheritanceRankElement.textContent = ranks.inheritance_rank ? ranks.inheritance_rank + '位' : '—';
        }
    }
    
    periodTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const period = this.getAttribute('data-period');
            
            // タブのアクティブ状態を更新
            periodTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // コンテンツの表示/非表示を切り替え
            periodContents.forEach(content => {
                if (content.getAttribute('data-period') === period) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
            
            // 統計セクションを更新
            updateUserRankings(period);
            
            // URLを更新（ページリロードなし）
            const url = new URL(window.location);
            url.searchParams.set('period', period);
            window.history.pushState({}, '', url);
        });
    });
});
</script>
{% endblock %}
