{% extends "base.html" %}

{% block title %}ランキング - ひらめきリレー{% endblock %}

{% block header_intro %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='ranking.css') }}">
{% endblock %}

{% block content %}
{% set total_ranked = rankings|length if rankings else 0 %}
{% set top_ranking = rankings[0] if rankings else None %}
<div class="ranking-main">
    <section class="ranking-hero">
        <div class="hero-copy">
            <h2>投稿数ランキング</h2>
            <div class="hero-metrics">
                <div class="metric-card">
                    <span class="metric-label">エントリー数</span>
                    <span class="metric-value">{{ total_ranked }}</span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">トップ投稿</span>
                    <span class="metric-value">
                        {% if top_ranking %}
                            {{ top_ranking.post_count }}
                        {% else %}
                            —
                        {% endif %}
                    </span>
                    <span class="metric-footnote">
                        {% if top_ranking %}
                            {{ top_ranking.nickname }}
                        {% else %}
                            集計中
                        {% endif %}
                    </span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">あなたの順位</span>
                    <span class="metric-value">
                        {% if current_user_rank %}
                            {{ current_user_rank }}位
                        {% else %}
                            —
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </section>

    <section class="ranking-container">
        <div class="ranking-tabs">
            <button class="tab-button active" data-tab="posts">
                <span class="tab-label">投稿数</span>
            </button>
            <button class="tab-button disabled" data-tab="inheritance" disabled>
                <span class="tab-label">継承数</span>
                <span class="tab-badge">準備中</span>
            </button>
        </div>

        <!-- Period Tabs -->
        <div class="period-tabs">
            <button class="period-tab {% if current_period == 'all' %}active{% endif %}" data-period="all">総合</button>
            <button class="period-tab {% if current_period == 'yearly' %}active{% endif %}" data-period="yearly">年間</button>
            <button class="period-tab {% if current_period == 'monthly' %}active{% endif %}" data-period="monthly">月間</button>
            <button class="period-tab {% if current_period == 'weekly' %}active{% endif %}" data-period="weekly">週間</button>
        </div>

            <!-- Ranking Content for each period -->
        <div class="ranking-content">
            {% for period_key, period_name in [('all', '総合'), ('yearly', '年間'), ('monthly', '月間'), ('weekly', '週間')] %}
            <div class="period-ranking-content" data-period="{{ period_key }}" {% if current_period != period_key %}style="display: none;"{% else %}style="display: block;"{% endif %}>
                {% set period_rankings = rankings_by_period[period_key] %}
                {% if period_rankings %}
                <div class="ranking-list">
                    {% for ranking in period_rankings %}
                    <div class="ranking-item {% if ranking.user_id == current_user_id %}current-user{% endif %}">
                        <div class="rank-number {% if ranking.rank == 1 %}rank-gold{% elif ranking.rank == 2 %}rank-silver{% elif ranking.rank == 3 %}rank-bronze{% endif %}">
                            <span class="rank-text">{{ ranking.rank }}</span>
                        </div>
                        <div class="user-info">
                            <div class="user-avatar">
                                {% if ranking.icon_path %}
                                    {% if ranking.icon_path.startswith('uploads/') %}
                                        <img src="{{ url_for('uploaded_file', filename=ranking.icon_path[8:]) }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% elif ranking.icon_path.startswith('http') %}
                                        <img src="{{ ranking.icon_path }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% else %}
                                        <img src="{{ url_for('static', filename=ranking.icon_path) }}" alt="{{ ranking.nickname }}" class="avatar-image">
                                    {% endif %}
                                {% else %}
                                    <span class="avatar-text">{{ ranking.nickname[0] if ranking.nickname else 'U' }}</span>
                                {% endif %}
                            </div>
                            <div class="user-details">
                                <div class="user-name">{{ ranking.nickname }}</div>
                                <div class="user-id">@{{ ranking.user_id }}</div>
                            </div>
                        </div>
                        <div class="rank-stats">
                            <div class="stat-value">{{ ranking.post_count }}</div>
                            <div class="stat-label">投稿</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-message">
                    <p>まだランキングデータがありません。</p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodTabs = document.querySelectorAll('.period-tab');
    const periodContents = document.querySelectorAll('.period-ranking-content');
    
    periodTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const period = this.getAttribute('data-period');
            
            // タブのアクティブ状態を更新
            periodTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // コンテンツの表示/非表示を切り替え
            periodContents.forEach(content => {
                if (content.getAttribute('data-period') === period) {
                    content.style.display = 'block';
                } else {
                    content.style.display = 'none';
                }
            });
            
            // URLを更新（ページリロードなし）
            const url = new URL(window.location);
            url.searchParams.set('period', period);
            window.history.pushState({}, '', url);
            
            // 現在のユーザーの順位を再計算
            const activeContent = document.querySelector(`.period-ranking-content[data-period="${period}"]`);
            if (activeContent) {
                const currentUserItems = activeContent.querySelectorAll('.ranking-item.current-user');
                // 順位の再表示は必要に応じて実装
            }
        });
    });
});
</script>
{% endblock %}
