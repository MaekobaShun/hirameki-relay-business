{% extends "base.html" %}

{% block title %}ã²ã‚‰ã‚ããƒªãƒ¬ãƒ¼ - ã‚¢ã‚¤ãƒ‡ã‚¢æŠ•ç¨¿{% endblock %}

{% block header_intro %}
<p class="header-eyebrow">POST</p>
<h1 class="header-title">ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æŠ•ç¨¿</h1>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='form.css') }}">
{% endblock %}

{% block content %}
<div class="form-main">
    <section class="form-card glass-card">
        <div class="form-top">
            <h2 class="form-title">ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æŠ•ç¨¿</h2>
        </div>

        <!-- Flash messages are handled in base.html, but if we want them inside the card, we can keep them here too or rely on base. 
             base.html handles them at the top of main content. I will remove them from here to avoid duplication. -->
        
        <form method="post" action="{{ url_for('post') }}" class="idea-form">
            <div class="form-group">
                <label for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                <input type="text" id="title" name="title" class="form-input" placeholder="ã‚¢ã‚¤ãƒ‡ã‚¢ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" required value="{{ form_data.title if form_data else '' }}">
                <div class="character-counter">
                    <span id="title-count">0/60</span>
                </div>
            </div>

            <div class="form-group">
                <label for="detail">è©³ç´°ï¼ˆè§£æ±ºã—ãŸã„èª²é¡Œã€å…·ä½“çš„ãªæ©Ÿèƒ½ã€æœŸå¾…ã™ã‚‹åŠ¹æœãªã©ï¼‰</label>
                <textarea name="detail" id="detail" class="form-textarea" placeholder="ä¾‹ï¼šèª°ãŒã€ã©ã®ã‚ˆã†ãªå ´é¢ã§ã€ã©ã®ã‚ˆã†ãªå•é¡Œã‚’æŠ±ãˆã¦ã„ã‚‹ã‹ã€‚ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã§ã©ã®ã‚ˆã†ã«è§£æ±ºã™ã‚‹ã‹ã€‚å…·ä½“çš„ãªæ©Ÿèƒ½ã‚„ç‰¹å¾´ãªã©"
                    required>{{ form_data.detail if form_data else '' }}</textarea>
                <div class="character-counter">
                    <span id="detail-count">0/500</span>
                </div>
            </div>

            <div class="form-group">
                <label for="category">ã‚«ãƒ†ã‚´ãƒª</label>
                <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                    <select name="category" id="category" class="form-select" required style="flex: 1;">
                        <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ãƒ“ã‚¸ãƒã‚¹ãƒ»æ¥­å‹™åŠ¹ç‡åŒ–" {% if form_data and form_data.category == 'ãƒ“ã‚¸ãƒã‚¹ãƒ»æ¥­å‹™åŠ¹ç‡åŒ–' %}selected{% endif %}>ãƒ“ã‚¸ãƒã‚¹ãƒ»æ¥­å‹™åŠ¹ç‡åŒ–</option>
                        <option value="æ•™è‚²" {% if form_data and form_data.category == 'æ•™è‚²' %}selected{% endif %}>æ•™è‚²</option>
                        <option value="ã‚¨ãƒ³ã‚¿ãƒ¡" {% if form_data and form_data.category == 'ã‚¨ãƒ³ã‚¿ãƒ¡' %}selected{% endif %}>ã‚¨ãƒ³ã‚¿ãƒ¡</option>
                        <option value="ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ»å‰µä½œæ”¯æ´" {% if form_data and form_data.category == 'ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ»å‰µä½œæ”¯æ´' %}selected{% endif %}>ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãƒ»å‰µä½œæ”¯æ´</option>
                        <option value="ç”Ÿæ´»ãƒ»ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«" {% if form_data and form_data.category == 'ç”Ÿæ´»ãƒ»ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«' %}selected{% endif %}>ç”Ÿæ´»ãƒ»ãƒ©ã‚¤ãƒ•ã‚¹ã‚¿ã‚¤ãƒ«</option>
                        <option value="ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³" {% if form_data and form_data.category == 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³' %}selected{% endif %}>ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³</option>
                        <option value="é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«" {% if form_data and form_data.category == 'é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«' %}selected{% endif %}>é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«</option>
                        <option value="ãã®ä»–" {% if form_data and form_data.category == 'ãã®ä»–' %}selected{% endif %}>ãã®ä»–</option>
                    </select>
                    <button type="button" id="category-suggest-btn" class="category-suggest-button" style="padding: 0.95rem 1.5rem; border-radius: 1rem; border: 1.5px solid rgba(129, 140, 248, 0.8); background: rgba(243, 244, 255, 0.8); color: #6366f1; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.25s ease; font-size: 0.95rem;">
                        <span id="category-suggest-text">ğŸ¤– è‡ªå‹•åˆ¤å®š</span>
                        <span id="category-suggest-loading" style="display: none;">åˆ¤å®šä¸­...</span>
                    </button>
                </div>
                <p id="category-suggest-message" style="font-size: 0.85rem; color: #6b7280; margin-top: 0.5rem; min-height: 1.2rem;"></p>
            </div>

            <div class="form-actions">
                <button type="submit" class="submit-button">æŠ•ç¨¿ã™ã‚‹</button>
                <a href="{{ url_for('index') }}" class="cancel-link">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
            </div>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    (function () {
        const fields = [
            {
                element: document.querySelector('input[name="title"]'),
                counter: document.getElementById('title-count'),
                limit: 60
            },
            {
                element: document.querySelector('textarea[name="detail"]'),
                counter: document.getElementById('detail-count'),
                limit: 500
            }
        ];

        // æ–‡å­—æ•°ã‚’è¨ˆç®—ï¼ˆæ—¥æœ¬èªã‚‚1æ–‡å­—ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆï¼‰
        const calculateLength = (text) => {
            return text.length;
        };

        const truncateToLimit = (text, limit) => {
            if (text.length > limit) {
                return text.substring(0, limit);
            }
            return text;
        };

        const updateCounter = (field) => {
            const { element, counter, limit } = field;
            if (!element || !counter) {
                return;
            }

            let value = element.value;
            let currentLength = calculateLength(value);

            if (currentLength > limit) {
                value = truncateToLimit(value, limit);
                element.value = value;
                currentLength = calculateLength(value);
            }

            counter.textContent = `${currentLength}/${limit}`;
        };

        fields.forEach((field) => {
            if (!field.element || !field.counter) {
                return;
            }
            field.element.addEventListener('input', () => updateCounter(field));
            updateCounter(field);
        });

        // ã‚«ãƒ†ã‚´ãƒªè‡ªå‹•åˆ¤å®šãƒœã‚¿ãƒ³ã®å‡¦ç†
        const categorySuggestBtn = document.getElementById('category-suggest-btn');
        const categorySelect = document.getElementById('category');
        const categorySuggestText = document.getElementById('category-suggest-text');
        const categorySuggestLoading = document.getElementById('category-suggest-loading');
        const categorySuggestMessage = document.getElementById('category-suggest-message');
        const titleInput = document.querySelector('input[name="title"]');
        const detailTextarea = document.querySelector('textarea[name="detail"]');

        // ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœ
        if (categorySuggestBtn) {
            categorySuggestBtn.addEventListener('mouseenter', function() {
                if (!this.disabled) {
                    this.style.background = 'rgba(129, 140, 248, 0.15)';
                    this.style.borderColor = 'rgba(99, 102, 241, 0.9)';
                    this.style.transform = 'translateY(-2px)';
                }
            });
            categorySuggestBtn.addEventListener('mouseleave', function() {
                if (!this.disabled) {
                    this.style.background = 'rgba(243, 244, 255, 0.8)';
                    this.style.borderColor = 'rgba(129, 140, 248, 0.8)';
                    this.style.transform = 'translateY(0)';
                }
            });
            categorySuggestBtn.addEventListener('mousedown', function() {
                if (!this.disabled) {
                    this.style.transform = 'translateY(0)';
                }
            });
        }

        if (categorySuggestBtn && categorySelect) {
            categorySuggestBtn.addEventListener('click', async function() {
                const title = titleInput.value.trim();
                const detail = detailTextarea.value.trim();

                if (!title || !detail) {
                    categorySuggestMessage.textContent = 'ã‚¿ã‚¤ãƒˆãƒ«ã¨è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    categorySuggestMessage.style.color = '#ef4444';
                    return;
                }

                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                categorySuggestBtn.disabled = true;
                categorySuggestBtn.style.opacity = '0.6';
                categorySuggestBtn.style.cursor = 'not-allowed';
                categorySuggestText.style.display = 'none';
                categorySuggestLoading.style.display = 'inline';
                categorySuggestMessage.textContent = '';
                categorySuggestMessage.style.color = '#6b7280';

                try {
                    const response = await fetch('/api/suggest-category', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            title: title,
                            detail: detail
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.category) {
                        // åˆ¤å®šçµæœã‚’ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«åæ˜ 
                        categorySelect.value = data.category;
                        categorySuggestMessage.textContent = `ã‚«ãƒ†ã‚´ãƒªã‚’ã€Œ${data.category}ã€ã«è‡ªå‹•åˆ¤å®šã—ã¾ã—ãŸ`;
                        categorySuggestMessage.style.color = '#10b981';
                        
                        // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦é¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸã“ã¨ã‚’é€šçŸ¥
                        categorySelect.dispatchEvent(new Event('change'));
                    } else {
                        categorySuggestMessage.textContent = data.error || 'ã‚«ãƒ†ã‚´ãƒªã‚’åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚';
                        categorySuggestMessage.style.color = '#ef4444';
                    }
                } catch (error) {
                    console.error('ã‚«ãƒ†ã‚´ãƒªåˆ¤å®šã‚¨ãƒ©ãƒ¼:', error);
                    categorySuggestMessage.textContent = 'ã‚«ãƒ†ã‚´ãƒªåˆ¤å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚';
                    categorySuggestMessage.style.color = '#ef4444';
                } finally {
                    // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                    categorySuggestBtn.disabled = false;
                    categorySuggestBtn.style.opacity = '1';
                    categorySuggestBtn.style.cursor = 'pointer';
                    categorySuggestText.style.display = 'inline';
                    categorySuggestLoading.style.display = 'none';
                }
            });
        }
    })();
</script>
{% endblock %}
