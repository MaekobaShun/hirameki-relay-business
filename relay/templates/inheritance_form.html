{% extends "base.html" %}

{% block title %}ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç¶™æ‰¿ - ã²ã‚‰ã‚ããƒªãƒ¬ãƒ¼{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='form.css') }}">
{% endblock %}

{% block content %}
<div class="form-main">
    <section class="form-card glass-card">
        <div class="form-top">
            <h2 class="form-title">ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ç¶™æ‰¿</h2>
            <p class="form-subtitle">ç¶™æ‰¿å…ƒã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ã—ã¦ã€æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
        </div>

        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="flash-messages">
            {% for message in messages %}
            <p>{{ message }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <!-- ç¶™æ‰¿å…ƒã®ã‚¢ã‚¤ãƒ‡ã‚¢æƒ…å ± -->
        <div class="inheritance-source">
            <h3 class="inheritance-source-title">ç¶™æ‰¿å…ƒã®ã‚¢ã‚¤ãƒ‡ã‚¢</h3>
            <div class="inheritance-source-card">
                <div class="inheritance-source-header">
                    <h4>{{ idea.title }}</h4>
                    <span class="inheritance-source-category">ğŸ“ {{ idea.category }}</span>
                </div>
                <p class="inheritance-source-detail">{{ idea.detail }}</p>
                <div class="inheritance-source-footer">
                    <span class="inheritance-source-author">ä½œæˆè€…: {{ idea.author_nickname }}</span>
                    <span class="inheritance-source-date">{{ idea.created_at }}</span>
                </div>
            </div>
        </div>

        <!-- ç¶™æ‰¿ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form method="post" action="{{ url_for('save_inheritance', idea_id=idea.idea_id) }}" class="idea-form"
            id="inheritance-form">
            <input type="hidden" name="parent_idea_id" value="{{ idea.idea_id }}">
            <input type="hidden" name="parent_user_id" value="{{ idea.user_id }}">

            <div class="form-group">
                <label for="add_point">è¿½åŠ ã—ãŸãƒã‚¤ãƒ³ãƒˆ <span class="required-mark">*</span></label>
                <input type="text" id="add_point" name="add_point" class="form-input"
                    placeholder="ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã«è¿½åŠ ã—ãŸãƒã‚¤ãƒ³ãƒˆã‚’ç°¡æ½”ã«è¨˜å…¥ã—ã¦ãã ã•ã„" required maxlength="64">
                <div class="character-counter">
                    <span id="add-point-count">0/64</span>
                </div>
                <p class="form-hint">ã“ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã«ä½•ã‚’è¿½åŠ ãƒ»æ”¹å–„ã—ãŸã‹ã‚’ç°¡æ½”ã«è¨˜å…¥ã—ã¦ãã ã•ã„</p>
            </div>

            <div class="form-group">
                <label for="add_detail">è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
                <textarea name="add_detail" id="add_detail" class="form-textarea"
                    placeholder="è¿½åŠ ã—ãŸãƒã‚¤ãƒ³ãƒˆã®è©³ç´°ã‚„ã€æ”¹å–„å†…å®¹ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰" rows="6"></textarea>
                <div class="character-counter">
                    <span id="add-detail-count">0/500</span>
                </div>
            </div>

            <div class="form-actions inheritance-actions">
                <button type="submit" name="action" value="save" class="submit-button save-button">ä¿å­˜</button>
                <button type="submit" name="action" value="post" class="submit-button post-button">æ–°è¦æŠ•ç¨¿</button>
                <a href="{{ url_for('mypage') }}" class="cancel-link">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</a>
            </div>
        </form>
    </section>
</div>

<div class="floating-sparkle sparkle-1">âœ¨</div>
<div class="floating-sparkle sparkle-2">âœ¨</div>
{% endblock %}

{% block extra_scripts %}
<script>
    (function () {
        const fields = [
            {
                element: document.getElementById('add_point'),
                counter: document.getElementById('add-point-count'),
                limit: 64
            },
            {
                element: document.getElementById('add_detail'),
                counter: document.getElementById('add-detail-count'),
                limit: 500
            }
        ];

        const getCharLength = (char) => {
            if (/^[\u0000-\u007F]$/.test(char)) {
                return 1;
            }
            if (/^[\uFF61-\uFF9F]$/.test(char)) {
                return 1;
            }
            return 2;
        };

        const calculateLength = (text) => {
            let length = 0;
            for (const ch of text) {
                length += getCharLength(ch);
            }
            return length;
        };

        const truncateToLimit = (text, limit) => {
            let length = 0;
            let result = '';
            for (const ch of text) {
                const charLength = getCharLength(ch);
                if (length + charLength > limit) {
                    break;
                }
                length += charLength;
                result += ch;
            }
            return result;
        };

        const updateCounter = (field) => {
            const { element, counter, limit } = field;
            if (!element || !counter) {
                return;
            }

            let value = element.value;
            let currentLength = calculateLength(value);

            if (currentLength > limit) {
                value = truncateToLimit(value, limit);
                element.value = value;
                currentLength = calculateLength(value);
            }

            counter.textContent = `${currentLength}/${limit}`;
        };

        fields.forEach((field) => {
            if (!field.element || !field.counter) {
                return;
            }
            field.element.addEventListener('input', () => updateCounter(field));
            updateCounter(field);
        });

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
        const form = document.getElementById('inheritance-form');
        if (form) {
            form.addEventListener('submit', function (e) {
                const submitButton = e.submitter;
                if (submitButton && submitButton.name === 'action') {
                    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã®actionã‚’å¤‰æ›´
                    if (submitButton.value === 'save') {
                        form.action = "{{ url_for('save_inheritance', idea_id=idea.idea_id) }}";
                    } else if (submitButton.value === 'post') {
                        form.action = "{{ url_for('post_inheritance', idea_id=idea.idea_id) }}";
                    }
                } else {
                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ä¿å­˜
                    form.action = "{{ url_for('save_inheritance', idea_id=idea.idea_id) }}";
                }
            });
        }
    })();
</script>
{% endblock %}
