{% extends "base.html" %}

{% block title %}{{ event.name }} - ä¼šå ´{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='event_detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='events.css') }}">
{% endblock %}

{% block header_intro %}
<p class="header-eyebrow">EVENT VENUE</p>
<h1 class="header-title">ã‚¤ãƒ™ãƒ³ãƒˆä¼šå ´</h1>
{% endblock %}

{% block content %}
<div class="event-dashboard-wrapper">
    <!-- Event Info Card -->
    <div class="event-info-card">
        <div class="header-breadcrumbs">
            <a href="{{ url_for('events') }}" class="back-link">
                <span class="back-arrow">â†</span> ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
            </a>
        </div>
        <h1 class="event-title">{{ event.name }}</h1>
        <div class="header-meta">
            <span class="meta-item">
                <span class="icon">ğŸ‘¤</span>
                ä¸»å‚¬: {{ event.creator_nickname }}
            </span>
            <span class="meta-item">
                <span class="icon">ğŸ“…</span>
                {{ event.start_date.strftime('%Y/%m/%d %H:%M') }} ã€œ {{ event.end_date.strftime('%Y/%m/%d %H:%M') }}
            </span>
            {% if event.is_public %}
                <span class="status-badge status-public">å…¬é–‹</span>
            {% else %}
                <span class="status-badge status-private">éå…¬é–‹</span>
            {% endif %}
        </div>
    </div>

    <!-- Top Status / Countdown -->
    {% if event.status == 'active' %}
    <div class="countdown-banner">
        <div class="countdown-content">
            <h3>æ®‹ã‚Šæ™‚é–“</h3>
            <div id="countdown-timer" class="timer-display">è¨ˆç®—ä¸­...</div>
        </div>
        <div class="countdown-decoration">â³</div>
    </div>
    {% endif %}

    <!-- Admin Actions -->
    {% if event.is_creator %}
    <div class="admin-actions-card">
        <div class="admin-actions-header">
            <h3>ä¸»å‚¬è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
        </div>
        <div class="admin-buttons">
            <button type="button" onclick="document.getElementById('edit-event-modal').showModal()" class="btn-admin btn-edit">
                <span class="icon">âœï¸</span> ç·¨é›†
            </button>
            <form method="POST" action="{{ url_for('event_delete', event_id=event.event_id) }}" onsubmit="return confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚');" class="delete-form">
                <button type="submit" class="btn-admin btn-delete">
                    <span class="icon">ğŸ—‘ï¸</span> å‰Šé™¤
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon-wrapper">
                <img src="{{ url_for('static', filename='images/user-svgrepo-com.svg') }}" alt="å‚åŠ è€…">
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ participant_count }}</div>
                <div class="stat-label">å‚åŠ è€…</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon-wrapper post-icon">
                <img src="{{ url_for('static', filename='images/edit-1479-svgrepo-com.svg') }}" alt="æŠ•ç¨¿">
            </div>
            <div class="stat-content">
                <div class="stat-value">{{ idea_count }}</div>
                <div class="stat-label">æŠ•ç¨¿æ•°</div>
            </div>
        </div>
    </div>

    <div class="content-columns">
        <!-- Rankings Column -->
        <div class="column-main">
            <section class="ranking-section">
                <div class="section-header">
                    <h3 class="section-title">
                        <img src="{{ url_for('static', filename='images/ranking-1-svgrepo-com.svg') }}" class="section-title-icon" alt="ãƒ©ãƒ³ã‚­ãƒ³ã‚°">
                        ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                    </h3>
                </div>
                
                {% if rankings %}
                <div class="ranking-list">
                    {% for ranking in rankings %}
                    {% set rank = loop.index %}
                    <div class="ranking-item">
                        <div class="rank-number {% if rank == 1 %}rank-gold{% elif rank == 2 %}rank-silver{% elif rank == 3 %}rank-bronze{% endif %}">
                            {{ rank }}
                        </div>
                        <div class="rank-user-info">
                            <div class="user-avatar">
                                {% if ranking.icon_path %}
                                    {% if ranking.icon_path.startswith('uploads/') %}
                                        <img src="{{ url_for('uploaded_file', filename=ranking.icon_path[8:]) }}" alt="{{ ranking.nickname }}">
                                    {% elif ranking.icon_path.startswith('http') %}
                                        <img src="{{ ranking.icon_path }}" alt="{{ ranking.nickname }}">
                                    {% else %}
                                        <img src="{{ url_for('static', filename=ranking.icon_path) }}" alt="{{ ranking.nickname }}">
                                    {% endif %}
                                {% else %}
                                    <span class="avatar-text">{{ ranking.nickname[0] }}</span>
                                {% endif %}
                            </div>
                            <div class="rank-details">
                                <div class="rank-name">{{ ranking.nickname }}</div>
                            </div>
                        </div>
                        <div class="rank-score">
                            <div class="score-value">{{ ranking.post_count }}</div>
                            <div class="score-label">æŠ•ç¨¿</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <p>ã¾ã ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
                {% endif %}
            </section>
        </div>

        <!-- Participants Column -->
        <div class="column-side">
            <section class="participants-section">
                <div class="section-header">
                    <h3 class="section-title">
                        ğŸ‘¥ å‚åŠ è€…ä¸€è¦§
                    </h3>
                    <span class="participant-count-badge">{{ participant_count }}å</span>
                </div>
                <div class="participants-list">
                    {% for participant in participants %}
                    <div class="participant-item">
                        <div class="user-avatar small">
                            {% if participant.icon_path %}
                                {% if participant.icon_path.startswith('uploads/') %}
                                    <img src="{{ url_for('uploaded_file', filename=participant.icon_path[8:]) }}" alt="{{ participant.nickname }}">
                                {% elif participant.icon_path.startswith('http') %}
                                    <img src="{{ participant.icon_path }}" alt="{{ participant.nickname }}">
                                {% else %}
                                    <img src="{{ url_for('static', filename=participant.icon_path) }}" alt="{{ participant.nickname }}">
                                {% endif %}
                            {% else %}
                                <span class="avatar-text">{{ participant.nickname[0] }}</span>
                            {% endif %}
                        </div>
                        <span class="participant-name">{{ participant.nickname }}</span>
                    </div>
                    {% endfor %}
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Edit Event Modal -->
{% if event.is_creator %}
<dialog id="edit-event-modal" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†</h3>
            <button type="button" onclick="document.getElementById('edit-event-modal').close()" class="modal-close-btn">Ã—</button>
        </div>
        <form method="POST" action="{{ url_for('event_edit', event_id=event.event_id) }}" class="modal-form">
            <div class="form-group">
                <label for="edit_event_name">ã‚¤ãƒ™ãƒ³ãƒˆå</label>
                <input type="text" id="edit_event_name" name="name" required value="{{ event.name }}" placeholder="ä¾‹ï¼šå¤ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_start_date">é–‹å§‹æ—¥æ™‚</label>
                    <input type="datetime-local" id="edit_start_date" name="start_date" required value="{{ event.start_date_str }}">
                </div>
                <div class="form-group">
                    <label for="edit_end_date">çµ‚äº†æ—¥æ™‚</label>
                    <input type="datetime-local" id="edit_end_date" name="end_date" required value="{{ event.end_date_str }}">
                </div>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="edit_is_public" name="is_public" value="1" {% if event.is_public %}checked{% endif %}>
                    <span>ã‚¤ãƒ™ãƒ³ãƒˆã‚’å…¬é–‹ã™ã‚‹ï¼ˆä¸€è¦§ã«è¡¨ç¤ºï¼‰</span>
                </label>
                <p class="form-hint">ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨éå…¬é–‹ã¨ãªã‚Šã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’çŸ¥ã£ã¦ã„ã‚‹äººã®ã¿å‚åŠ ã§ãã¾ã™</p>
            </div>

            <div class="modal-footer">
                <button type="button" onclick="document.getElementById('edit-event-modal').close()" class="btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="btn-submit">å¤‰æ›´ã‚’ä¿å­˜ã™ã‚‹</button>
            </div>
        </form>
    </div>
</dialog>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% if event.status == 'active' %}
<script>
    function updateCountdown() {
        const endDate = new Date('{{ event.end_date.isoformat() }}');
        const now = new Date();
        const diff = endDate - now;

        const timerDisplay = document.getElementById('countdown-timer');
        if (!timerDisplay) return;

        if (diff <= 0) {
            timerDisplay.textContent = 'ã‚¤ãƒ™ãƒ³ãƒˆã¯çµ‚äº†ã—ã¾ã—ãŸ';
            return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        let text = '';
        if (days > 0) text += `<span class="time-unit">${days}<small>æ—¥</small></span>`;
        text += `<span class="time-unit">${hours}<small>æ™‚é–“</small></span>`;
        text += `<span class="time-unit">${minutes}<small>åˆ†</small></span>`;
        text += `<span class="time-unit">${seconds}<small>ç§’</small></span>`;

        timerDisplay.innerHTML = text;
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
</script>
{% endif %}

<script>
    // Close modal when clicking outside
    document.querySelectorAll('dialog').forEach(dialog => {
        dialog.addEventListener('click', (event) => {
            if (event.target === dialog) {
                dialog.close();
            }
        });
    });
</script>
{% endblock %}